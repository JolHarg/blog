<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom"><title type="text">Posts tagged with internet connection sharing: JolHarg: Software and Technology Blog</title><id>https://blog.jolharg.com/atom.xml</id><updated>2010-11-13 13:10:00 UTC</updated><link href="https://blog.jolharg.com/tag/internet%20connection%20sharing"/><entry><id>how-to-use-ssh-for-internet-connection</id><title type="text">How to use SSH for an Internet Connection Sharing Proxy</title><updated>2010-11-13 13:10:00 UTC</updated><author><name>Dan Dart</name></author><content type="html">&lt;p&gt;I haven't made a blog in a long while, so I'd thought I'd share this, which I recently discovered how to do.&lt;/p&gt;
&lt;p&gt;If you find the idea of proxies a bit restrictive. because after all, they have to be set up in the applications in question, and may not work for some applications, help is here. And all you need is an SSH server you can connect to. Sadly, this method requires root, but it's worth having for the system-wide Internet connection you'll get from it.&lt;/p&gt;
&lt;hr /&gt;
&lt;h2 id="authenticating-as-root"&gt;Authenticating as root&lt;/h2&gt;
&lt;p&gt;First, make sure you're root on the client machine (sudo -s or su -, depending on your distro), and that you can ssh as root to your target server. This is of course causes security implications, so it may be a good idea to generate a key pair for root-to-root access and block off passworded access for root, so that no one can bruteforce your root password.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Generate the key pair as root on the client:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb1"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb1-1"&gt;&lt;a href="#cb1-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; ssh-keygen&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;And copy the key to the server&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb2"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb2-1"&gt;&lt;a href="#cb2-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; ssh-copy-id &lt;span class="pp"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;server&lt;/span&gt;&lt;span class="pp"&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Test the root login. It should not prompt you for password authentication (unless you've set one in ssh-keygen). Now, to block off password logins, edit /etc/ssh/sshd_config (or /etc/sshd/sshd_config) on the server and make sure this line is present:&lt;/p&gt;
&lt;pre class="sshd_config"&gt;&lt;code&gt;PermitRootLogin without-password&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Hooray! We're now somewhat more secure!&lt;/p&gt;
&lt;hr /&gt;
&lt;h2 id="creating-the-tunnel"&gt;Creating the tunnel&lt;/h2&gt;
&lt;p&gt;Now to start a tunnel. The -w switch on ssh will do what we need, and create a tunnel network interface on both computers. The first number is the number of the interface on the client, and the second is for the server. For example, 0:! will create tun0 on the client connected to tun1 on the server. You may specify auto for the next available one. Let's create tunnels called tun0 to make it simpler.&lt;/p&gt;
&lt;div class="sourceCode" id="cb4"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb4-1"&gt;&lt;a href="#cb4-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; ssh &lt;span class="at"&gt;-w0:0&lt;/span&gt; &lt;span class="pp"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;server&lt;/span&gt;&lt;span class="pp"&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Now, see if your tunnels were set up correctly.&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb5"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb5-1"&gt;&lt;a href="#cb5-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; ifconfig &lt;span class="at"&gt;-a&lt;/span&gt; tun0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see a tun0 interface. This is a layer 3 tunneled virtual interface (point-to-point).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Set up an IP on both sides so each computer can talk to each other.&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb6"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb6-1"&gt;&lt;a href="#cb6-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; ifconfig tun0 10.0.0.1 pointopoint 10.0.0.2&lt;/span&gt;
&lt;span id="cb6-2"&gt;&lt;a href="#cb6-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; ifconfig tun0 10.0.0.2 pointopoint 10.0.0.1&lt;span class="kw"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Try pinging each side to see if you have a connection.&lt;/p&gt;
&lt;p&gt;Once each host can talk to the other, we can set up the routing.&lt;/p&gt;
&lt;h2 id="setting-up-the-routing"&gt;Setting up the routing&lt;/h2&gt;
&lt;h3 id="server-setup"&gt;Server setup&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Ensure that the tun0 interface is not restricted:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb7"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb7-1"&gt;&lt;a href="#cb7-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; INPUT &lt;span class="at"&gt;-i&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;/span&gt;
&lt;span id="cb7-2"&gt;&lt;a href="#cb7-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; OUTPUT &lt;span class="at"&gt;-o&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;/span&gt;
&lt;span id="cb7-3"&gt;&lt;a href="#cb7-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; FORWARD &lt;span class="at"&gt;-i&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Allow packets in from the external interface to be processed by the tunnel:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb8"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb8-1"&gt;&lt;a href="#cb8-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; INPUT &lt;span class="at"&gt;-i&lt;/span&gt; eth0 &lt;span class="at"&gt;-d&lt;/span&gt; 10.0.0.2 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Allow forwarded packets to be routed to their destination:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb9"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb9-1"&gt;&lt;a href="#cb9-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; FORWARD &lt;span class="at"&gt;-i&lt;/span&gt; eth0 &lt;span class="at"&gt;-o&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;span class="kw"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Set up tun0 for NAT:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb10"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb10-1"&gt;&lt;a href="#cb10-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; POSTROUTING &lt;span class="at"&gt;-o&lt;/span&gt; tun0 &lt;span class="at"&gt;-t&lt;/span&gt; nat &lt;span class="at"&gt;-j&lt;/span&gt; MASQUERADE&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Enable IP forwarding in the kernel:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb11"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb11-1"&gt;&lt;a href="#cb11-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;server:~#&lt;/span&gt; echo 1 &lt;span class="op"&gt;&amp;gt;&lt;/span&gt; /proc/sys/net/ipv4/ip_forward&lt;span class="kw"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id="section"&gt;&lt;/h3&gt;
&lt;h3 id="client-setup"&gt;Client setup&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Allow packets to be processed from the tun0 interface:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb12"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb12-1"&gt;&lt;a href="#cb12-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; INPUT &lt;span class="at"&gt;-i&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;/span&gt;
&lt;span id="cb12-2"&gt;&lt;a href="#cb12-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; OUTPUT &lt;span class="at"&gt;-o&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;/span&gt;
&lt;span id="cb12-3"&gt;&lt;a href="#cb12-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; iptables &lt;span class="at"&gt;-A&lt;/span&gt; FORWARD &lt;span class="at"&gt;-i&lt;/span&gt; tun0 &lt;span class="at"&gt;-j&lt;/span&gt; ACCEPT&lt;span class="kw"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id="section-1"&gt;&lt;/h4&gt;
&lt;h4 id="setting-up-the-gateways"&gt;Setting up the gateways&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Find the existing default gateway:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb13"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb13-1"&gt;&lt;a href="#cb13-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; route &lt;span class="kw"&gt;|&lt;/span&gt; &lt;span class="fu"&gt;grep&lt;/span&gt; ^default&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Add a backbone to stop the server not being found once we switch gateways:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb14"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb14-1"&gt;&lt;a href="#cb14-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; route add [server IP] gw [existing default gateway]&lt;span class="kw"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Add the new default gateway:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb15"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb15-1"&gt;&lt;a href="#cb15-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; route add default gw 10.0.0.1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Remove the existing default gateway (Be very careful!):&lt;/strong&gt;&lt;/p&gt;
&lt;div class="sourceCode" id="cb16"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb16-1"&gt;&lt;a href="#cb16-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;client:~#&lt;/span&gt; route del default gw [existing default gateway]&lt;span class="kw"&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id="section-2"&gt;&lt;/h3&gt;
&lt;h3 id="testing-the-tunnel"&gt;Testing the tunnel&lt;/h3&gt;
&lt;p&gt;Try going to whatismyip.com in your browser. It should show you the IP of your server. If you're curious, you can also check the default route to somewhere like Google by using the traceroute utility.&lt;/p&gt;
&lt;p&gt;You're done!&lt;/p&gt;
&lt;h2 id="troubleshooting"&gt;Troubleshooting&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;I can't see a tun0 interface!&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Make sure you're root on both sides. (It sounds obvious - I've thumped my head on my desk so much because of this!)&lt;/p&gt;
&lt;p&gt;Start ssh with the &lt;code&gt;-v&lt;/code&gt; switch to show more verbosity. If you see a message a bit like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;debug1: Remote: Failed to open the tunnel device.
channel 0: open failed: administratively prohibited: open failed&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;it could mean that someone else is trying to create a tunnel with the same interface name on the server.&lt;/p&gt;
&lt;p&gt;If you see something a little like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;debug1: sys_tun_open: failed to configure tunnel (mode 1): Device or resource busy&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;it might mean that you already have a tunnel with that interface name open. Check &lt;code&gt;ifconfig -a&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;I get the message "ping: sendmsg: Operation not permitted" when testing the tunnel connection!&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;You didn't allow traffic to flow between the tunnel and local network device. Try turning the client firewall off.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;The connection is slow!&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;There will be significant overhead as all the traffic is encapsulated into SSH and encrypted. You will also see latencies go up as traffic needs to travel from your client to your server and back additionally.&lt;/p&gt;</content><link href="https://blog.jolharg.com/post/2010/11/how-to-use-ssh-for-internet-connection"/></entry></feed>