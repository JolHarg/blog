<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom"><title type="text">Posts tagged with delete: JolHarg: Software and Technology Blog</title><id>https://blog.jolharg.com/atom.xml</id><updated>2021-03-20 13:01:00 UTC</updated><link href="https://blog.jolharg.com/tag/delete"/><entry><id>ephemeral-system-with-nixos</id><title type="text">Ephemeral system with NixOS</title><updated>2021-03-20 13:01:00 UTC</updated><author><name>Dan Dart</name></author><content type="html">&lt;p&gt;Recently, I discovered the following reddit post and blog posts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.reddit.com/r/NixOS/comments/lyuxv5/erasing_root_on_every_boot/"&gt;Erasing root on every boot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://grahamc.com/blog/erase-your-darlings"&gt;Erase your darlings&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://elis.nu/blog/2020/05/nixos-tmpfs-as-root/"&gt;NixOS ❄: tmpfs as root&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://elis.nu/blog/2020/06/nixos-tmpfs-as-home/"&gt;NixOS ❄: tmpfs as home&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I thought I didn't need any kind of persistence tool, because btrfs is awesome. So I decided to give it a go myself.&lt;/p&gt;
&lt;p&gt;In my case, I'm using &lt;code&gt;btrfs&lt;/code&gt; so it's very easy to get going with.&lt;/p&gt;
&lt;p&gt;I went through and decided I wanted to keep:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/nix&lt;/code&gt; (of course, I don't want to have to download everything all the time)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/home&lt;/code&gt; (for now, I'll have a go at that one later)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/var/lib&lt;/code&gt; (databases, docker, etc)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/ssh&lt;/code&gt; (host keys)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/NetworkManager&lt;/code&gt; (system connections, VPNs etc)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And I was content with the rest being recreated on boot, especially &lt;code&gt;/tmp&lt;/code&gt;, because it vastly speeds up a lot of things!&lt;/p&gt;
&lt;p&gt;Firstly I converted the directories I wanted to keep into subvolumes (in rescue mode or live/other OS):&lt;/p&gt;
&lt;div class="sourceCode" id="cb1"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb1-1"&gt;&lt;a href="#cb1-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;mv&lt;/span&gt; /dir-to-keep /dir2&lt;/span&gt;
&lt;span id="cb1-2"&gt;&lt;a href="#cb1-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;btrfs&lt;/span&gt; su c /dir-to-keep&lt;/span&gt;
&lt;span id="cb1-3"&gt;&lt;a href="#cb1-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;cp&lt;/span&gt; &lt;span class="at"&gt;-rpv&lt;/span&gt; &lt;span class="at"&gt;--reflink&lt;/span&gt;&lt;span class="op"&gt;=&lt;/span&gt;always /dir2/&lt;span class="pp"&gt;*&lt;/span&gt; /dir-to-keep/&lt;/span&gt;
&lt;span id="cb1-4"&gt;&lt;a href="#cb1-4" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;rm&lt;/span&gt; &lt;span class="at"&gt;-rf&lt;/span&gt; /dir2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;--reflink=always&lt;/code&gt; makes a CoW copy in &lt;code&gt;btrfs&lt;/code&gt;, so this is a much faster way to copy over data.&lt;/p&gt;
&lt;p&gt;This worked for most of my directories, except for &lt;code&gt;/nix&lt;/code&gt;, so I had to use &lt;code&gt;--reflink=auto&lt;/code&gt; because I had a lot of hard links due to &lt;code&gt;nix-store&lt;/code&gt; optimisation, so it'll CoW only that which it can.&lt;/p&gt;
&lt;p&gt;Noteworthy is that to do &lt;code&gt;/nix&lt;/code&gt; to avoid commands disappearing involves doing this (optionally from the running system):&lt;/p&gt;
&lt;div class="sourceCode" id="cb2"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb2-1"&gt;&lt;a href="#cb2-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;btrfs&lt;/span&gt; su c /nix2&lt;/span&gt;
&lt;span id="cb2-2"&gt;&lt;a href="#cb2-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;cp&lt;/span&gt; &lt;span class="at"&gt;-rpv&lt;/span&gt; &lt;span class="at"&gt;--reflink&lt;/span&gt;&lt;span class="op"&gt;=&lt;/span&gt;auto /nix/&lt;span class="pp"&gt;*&lt;/span&gt; /nix2/ &lt;span class="co"&gt;# Many hardlinks may be duplicated!&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and then from a live or other system (because moving things in-use is dangerous and may not actually work):&lt;/p&gt;
&lt;div class="sourceCode" id="cb3"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb3-1"&gt;&lt;a href="#cb3-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;mount&lt;/span&gt; /dev/XXX /mnt/root&lt;/span&gt;
&lt;span id="cb3-2"&gt;&lt;a href="#cb3-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;rm&lt;/span&gt; &lt;span class="at"&gt;-rf&lt;/span&gt; /mnt/root/nix&lt;/span&gt;
&lt;span id="cb3-3"&gt;&lt;a href="#cb3-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="fu"&gt;mv&lt;/span&gt; /mnt/root/nix2 /mnt/root/nix&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally I'm able to have &lt;code&gt;/&lt;/code&gt; as a &lt;code&gt;tmpfs&lt;/code&gt;!&lt;/p&gt;
&lt;p&gt;So I added the following to &lt;code&gt;hardware-configuration.nix&lt;/code&gt;:&lt;/p&gt;
&lt;div class="sourceCode" id="cb4"&gt;&lt;pre class="sourceCode nix"&gt;&lt;code class="sourceCode nix"&gt;&lt;span id="cb4-1"&gt;&lt;a href="#cb4-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-2"&gt;&lt;a href="#cb4-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;fileSystems&lt;/span&gt;.&lt;span class="st"&gt;&amp;quot;/&amp;quot;&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-3"&gt;&lt;a href="#cb4-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-4"&gt;&lt;a href="#cb4-4" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;device&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;tmpfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-5"&gt;&lt;a href="#cb4-5" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;fsType&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;tmpfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-6"&gt;&lt;a href="#cb4-6" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;options&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="op"&gt;[&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-7"&gt;&lt;a href="#cb4-7" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;size=2G&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-8"&gt;&lt;a href="#cb4-8" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="op"&gt;];&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-9"&gt;&lt;a href="#cb4-9" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;};&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-10"&gt;&lt;a href="#cb4-10" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id="cb4-11"&gt;&lt;a href="#cb4-11" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;fileSystems&lt;/span&gt;.&lt;span class="st"&gt;&amp;quot;/nix&amp;quot;&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-12"&gt;&lt;a href="#cb4-12" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-13"&gt;&lt;a href="#cb4-13" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;device&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;/dev/XXX&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-14"&gt;&lt;a href="#cb4-14" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;fsType&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;btrfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-15"&gt;&lt;a href="#cb4-15" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;options&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="op"&gt;[&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-16"&gt;&lt;a href="#cb4-16" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;subvol=/nix&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-17"&gt;&lt;a href="#cb4-17" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;noatime&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-18"&gt;&lt;a href="#cb4-18" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="op"&gt;];&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-19"&gt;&lt;a href="#cb4-19" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;};&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-20"&gt;&lt;a href="#cb4-20" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id="cb4-21"&gt;&lt;a href="#cb4-21" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;fileSystems&lt;/span&gt;.&lt;span class="st"&gt;&amp;quot;/etc/ssh&amp;quot;&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-22"&gt;&lt;a href="#cb4-22" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-23"&gt;&lt;a href="#cb4-23" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;device&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;/dev/XXX&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-24"&gt;&lt;a href="#cb4-24" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;fsType&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;btrfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-25"&gt;&lt;a href="#cb4-25" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;options&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="op"&gt;[&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-26"&gt;&lt;a href="#cb4-26" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;subvol=/etc/ssh&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-27"&gt;&lt;a href="#cb4-27" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;noatime&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-28"&gt;&lt;a href="#cb4-28" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="op"&gt;];&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-29"&gt;&lt;a href="#cb4-29" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;};&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-30"&gt;&lt;a href="#cb4-30" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id="cb4-31"&gt;&lt;a href="#cb4-31" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;fileSystems&lt;/span&gt;.&lt;span class="st"&gt;&amp;quot;/etc/NetworkManager&amp;quot;&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-32"&gt;&lt;a href="#cb4-32" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-33"&gt;&lt;a href="#cb4-33" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;device&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;/dev/XXX&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-34"&gt;&lt;a href="#cb4-34" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;fsType&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;btrfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-35"&gt;&lt;a href="#cb4-35" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;options&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="op"&gt;[&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-36"&gt;&lt;a href="#cb4-36" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;subvol=/etc/NetworkManager&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-37"&gt;&lt;a href="#cb4-37" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;noatime&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-38"&gt;&lt;a href="#cb4-38" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="op"&gt;];&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-39"&gt;&lt;a href="#cb4-39" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;};&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-40"&gt;&lt;a href="#cb4-40" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id="cb4-41"&gt;&lt;a href="#cb4-41" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;fileSystems&lt;/span&gt;.&lt;span class="st"&gt;&amp;quot;/var/lib&amp;quot;&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-42"&gt;&lt;a href="#cb4-42" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-43"&gt;&lt;a href="#cb4-43" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;device&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;/dev/XXX&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-44"&gt;&lt;a href="#cb4-44" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;fsType&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;btrfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-45"&gt;&lt;a href="#cb4-45" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;options&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="op"&gt;[&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-46"&gt;&lt;a href="#cb4-46" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;subvol=/var/lib&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-47"&gt;&lt;a href="#cb4-47" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;noatime&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-48"&gt;&lt;a href="#cb4-48" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="op"&gt;];&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-49"&gt;&lt;a href="#cb4-49" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;};&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-50"&gt;&lt;a href="#cb4-50" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id="cb4-51"&gt;&lt;a href="#cb4-51" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;fileSystems&lt;/span&gt;.&lt;span class="st"&gt;&amp;quot;/home&amp;quot;&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-52"&gt;&lt;a href="#cb4-52" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-53"&gt;&lt;a href="#cb4-53" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;device&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;/dev/XXX&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-54"&gt;&lt;a href="#cb4-54" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;fsType&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;btrfs&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-55"&gt;&lt;a href="#cb4-55" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="va"&gt;options&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="op"&gt;[&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-56"&gt;&lt;a href="#cb4-56" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;subvol=/home&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-57"&gt;&lt;a href="#cb4-57" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;        &lt;span class="st"&gt;&amp;quot;noatime&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-58"&gt;&lt;a href="#cb4-58" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;      &lt;span class="op"&gt;];&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-59"&gt;&lt;a href="#cb4-59" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="op"&gt;};&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb4-60"&gt;&lt;a href="#cb4-60" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="op"&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and making sure my passwords were immutable and persistent via the clauses in configuration.nix:&lt;/p&gt;
&lt;div class="sourceCode" id="cb5"&gt;&lt;pre class="sourceCode nix"&gt;&lt;code class="sourceCode nix"&gt;&lt;span id="cb5-1"&gt;&lt;a href="#cb5-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="op"&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb5-2"&gt;&lt;a href="#cb5-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;users&lt;/span&gt;.&lt;span class="va"&gt;mutableUsers&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="cn"&gt;false&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb5-3"&gt;&lt;a href="#cb5-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;users&lt;/span&gt;.&lt;span class="va"&gt;users&lt;/span&gt;.&lt;span class="va"&gt;root&lt;/span&gt;.&lt;span class="va"&gt;initialHashedPassword&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;$6$8RZ1PPxKU6h$dNHnIWiq.h8s.7SpMW14FzK9bJwg1f6Mt.972/2Fij4zPrhR0X4m3JTNPtGAyeMKZk3I8x/Xro.vJolwVvwd9.&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb5-4"&gt;&lt;a href="#cb5-4" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;  &lt;span class="va"&gt;users&lt;/span&gt;.&lt;span class="va"&gt;users&lt;/span&gt;.&lt;span class="va"&gt;dwd&lt;/span&gt;.&lt;span class="va"&gt;initialHashedPassword&lt;/span&gt; &lt;span class="op"&gt;=&lt;/span&gt; &lt;span class="st"&gt;&amp;quot;$6$EDn9CboEV/$ESAQifZD0wiVkYf1MuyLqs.hP7mvelpoPnSGEI7CmwuUifi090PT6FQqHsdhlZSXSlqrT9EH.mIfUvxPCA5q.1&amp;quot;&lt;/span&gt;&lt;span class="op"&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb5-5"&gt;&lt;a href="#cb5-5" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="op"&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;(hey, they're hashed and SHA-512'd, do you want to try to crack them?)&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Triggering a rebuild and a reboot (to actually apply &lt;code&gt;/&lt;/code&gt; as &lt;code&gt;tmpfs&lt;/code&gt;), and success! Hooray!&lt;/p&gt;
&lt;p&gt;I can now delete everything from the root subvolume that I didn't make into a subvolume.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;tree -x&lt;/code&gt; from the root subvolume now looks like:&lt;/p&gt;
&lt;div class="sourceCode" id="cb6"&gt;&lt;pre class="sourceCode bash"&gt;&lt;code class="sourceCode bash"&gt;&lt;span id="cb6-1"&gt;&lt;a href="#cb6-1" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;$&lt;/span&gt; tree &lt;span class="at"&gt;-x&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb6-2"&gt;&lt;a href="#cb6-2" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="bu"&gt;.&lt;/span&gt;&lt;/span&gt;
&lt;span id="cb6-3"&gt;&lt;a href="#cb6-3" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;├──&lt;/span&gt; etc&lt;/span&gt;
&lt;span id="cb6-4"&gt;&lt;a href="#cb6-4" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;│  &lt;/span&gt; ├── NetworkManager&lt;/span&gt;
&lt;span id="cb6-5"&gt;&lt;a href="#cb6-5" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;│  &lt;/span&gt; └── ssh&lt;/span&gt;
&lt;span id="cb6-6"&gt;&lt;a href="#cb6-6" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;├──&lt;/span&gt; home&lt;/span&gt;
&lt;span id="cb6-7"&gt;&lt;a href="#cb6-7" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;├──&lt;/span&gt; nix&lt;/span&gt;
&lt;span id="cb6-8"&gt;&lt;a href="#cb6-8" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;&lt;span class="ex"&gt;└──&lt;/span&gt; var&lt;/span&gt;
&lt;span id="cb6-9"&gt;&lt;a href="#cb6-9" aria-hidden="true" tabindex="-1"&gt;&lt;/a&gt;    &lt;span class="ex"&gt;└──&lt;/span&gt; lib&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;so I can share these with another OS if I so wish.&lt;/p&gt;
&lt;p&gt;I'm currently investigating doing the same to &lt;code&gt;/home&lt;/code&gt;, so I'll keep you updated.&lt;/p&gt;
&lt;p&gt;Till next time!&lt;/p&gt;</content><link href="https://blog.jolharg.com/post/2021/03/ephemeral-system-with-nixos"/></entry></feed>